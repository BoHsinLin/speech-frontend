<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Listening AI</title>
  <style>
    :root{
      --bg:#f2f2f2;
      --panel:#ffffff;
      --text:#111;
      --muted:#8c8c8c;
      --line:#e6e6e6;
      --shadow: 0 8px 24px rgba(0,0,0,.08);
      --radius: 14px;
      --btn:#ffffff;
      --btn-border:#e8e8e8;
      --accent:#28c76f;
      --danger:#ff4d4f;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Microsoft JhengHei", "PingFang TC", sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .page{
      max-width: 420px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 18px 14px 26px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 6px 2px 10px;
    }
    .brand{
      font-weight:700;
      font-size: 18px;
      letter-spacing:.2px;
    }
    .auth a{
      color:#111;
      text-decoration:none;
      font-weight:600;
      font-size: 14px;
    }

    /* Timeline */
    .timeline-wrap{
      position: relative;
      margin: 2px 0 10px;
      padding-top: 8px;
    }
    .timer{
      text-align:center;
      font-variant-numeric: tabular-nums;
      font-weight:700;
      font-size: 14px;
      color:#111;
      margin-bottom: 8px;
    }
    .timeline{
      height: 18px;
      border-radius: 10px;
      background: linear-gradient(to right, transparent 0, transparent 100%);
      position: relative;
      overflow:hidden;
    }
    .ticks{
      position:absolute; inset:0;
      background-image: repeating-linear-gradient(
        to right,
        rgba(0,0,0,.12) 0,
        rgba(0,0,0,.12) 2px,
        transparent 2px,
        transparent 14px
      );
      opacity:.35;
    }
    .playhead{
      position:absolute;
      top:-8px;
      left:50%;
      width:2px;
      height: 34px;
      background: #ff5a5f;
      border-radius: 2px;
      transform: translateX(-50%);
      opacity:.9;
    }

    /* Controls Row */
    .controls{
      display:flex;
      gap: 10px;
      align-items:center;
      margin: 8px 0 12px;
    }
    .select{
      flex:1;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }
    .select button{
      all:unset;
      cursor:pointer;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .select .chev{
      color: var(--muted);
      font-size: 14px;
      margin-left: 6px;
    }
    .select .dropdown{
      position: relative;
    }
    .menu{
      position:absolute;
      top: 42px;
      left: 0;
      right: 0;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
      z-index: 10;
    }
    .menu button{
      all:unset;
      display:block;
      width:100%;
      padding: 12px 12px;
      cursor:pointer;
      font-weight:600;
    }
    .menu button:hover{
      background:#fafafa;
    }

    .bigbtn{
      width: 56px;
      height: 46px;
      border-radius: 12px;
      border: 1px solid var(--btn-border);
      background: var(--btn);
      display:grid;
      place-items:center;
      cursor:pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
      user-select:none;
      touch-action: manipulation;
    }
    .bigbtn:active{ transform: translateY(1px); }

    .icon{
      width: 22px; height: 22px; display:block;
    }
    .icon svg{ width:100%; height:100%; display:block; }

    /* Card */
    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      gap: 10px;
    }

    .langgroup{
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .pill{
      border: 1px solid var(--line);
      background:#fff;
      border-radius: 10px;
      padding: 6px 10px;
      font-weight:700;
      font-size: 13px;
      display:flex;
      align-items:center;
      gap: 8px;
      cursor:pointer;
      user-select:none;
    }
    .pill .swap{ color:#111; opacity:.9; }
    .mini-select{
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 6px 10px;
      font-weight:700;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
      background:#fff;
    }
    .actions{
      display:flex;
      gap: 10px;
      align-items:center;
      color: var(--muted);
    }
    .iconbtn{
      width: 34px;
      height: 34px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background:#fff;
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }

    .editor{
      padding: 12px 12px 10px;
    }
    textarea{
      width: 100%;
      min-height: 220px;
      border: 0;
      outline: none;
      resize: none;
      font-size: 16px;
      line-height: 1.6;
      font-family: inherit;
    }
    .placeholder{
      color: #b3b3b3;
    }
    .result{
      padding: 8px 12px 14px;
      border-top: 1px dashed #ededed;
      background: #fcfcfc;
    }
    .result .row{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      margin-top: 8px;
    }
    .tag{
      min-width: 38px;
      font-weight:800;
      font-size: 12px;
      color:#666;
      padding-top: 2px;
    }
    .textblock{
      flex:1;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 15px;
      line-height: 1.6;
      color:#111;
    }

    .status{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap: 10px;
    }
    .badge{
      font-weight:700;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background:#fff;
      color:#555;
      font-size: 12px;
    }

    /* History Section */
    .history-section{
      margin-top: 16px;
    }
    .history-header{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 4px;
    }
    .history-title{
      font-weight: 700;
      font-size: 14px;
      color: var(--muted);
    }
    .history-clear{
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid var(--line);
      background: #fff;
    }
    .history-clear:hover{
      background: #f5f5f5;
    }
    .history-list{
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .history-item{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px;
      opacity: 0.85;
      transition: opacity 0.2s;
    }
    .history-item:hover{
      opacity: 1;
    }
    .history-time{
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .history-row{
      display: flex;
      gap: 8px;
      align-items: flex-start;
      margin-top: 6px;
    }
    .history-tag{
      min-width: 32px;
      font-weight: 800;
      font-size: 11px;
      color: #888;
      padding-top: 1px;
    }
    .history-text{
      flex: 1;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 14px;
      line-height: 1.5;
      color: #333;
    }
    .history-empty{
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      padding: 20px;
    }

    /* Responsive */
    @media (max-width: 360px){
      .page{ padding: 14px 10px 22px; }
      textarea{ min-height: 200px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="topbar">
      <div class="brand">Translate Good Friend</div>

    </div>

    <div class="timeline-wrap">
      <div class="timer" id="timer">00:00:00</div>
      <div class="timeline">
        <div class="ticks"></div>
        <div class="playhead"></div>
      </div>
    </div>

    <div class="controls">
      <div class="select">
        <div class="dropdown">
          <button id="micBtn" type="button" aria-label="Microphone menu">
            <span id="micLabel">È∫•ÂÖãÈ¢®</span>
            <span class="chev">‚Ä∫</span>
          </button>
          <div class="menu" id="micMenu">
            <button data-mode="mic">È∫•ÂÖãÈ¢®ÔºàÈåÑÈü≥Ôºâ</button>
            <button data-mode="upload">‰∏äÂÇ≥Èü≥Ê™îÔºàWAVÔºâ</button>
          </div>
        </div>
      </div>

      <div class="bigbtn" id="recordBtn" title="ÈñãÂßã/ÂÅúÊ≠¢ÈåÑÈü≥">
        <span class="icon" id="recordIcon">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M8 5v14l11-7L8 5z" fill="var(--accent)"></path>
          </svg>
        </span>
      </div>
    </div>

    <div class="card">
      <div class="cardbar">
        <div class="langgroup">
          <div class="mini-select" id="langFrom">en</div>
          <div class="pill" id="swapBtn" title="‰∫§ÊèõË™ûË®Ä">
            <span class="swap">‚Üî</span>
            <span id="langTo">zh</span>
          </div>
        </div>

        <div class="actions">
          <div class="iconbtn" id="speakEnBtn" title="ÊúóËÆÄËã±Êñá">
            üîä<span style="font-size:12px;font-weight:800;margin-left:2px;">en</span>
          </div>
          <div class="iconbtn" id="speakZhBtn" title="ÊúóËÆÄ‰∏≠Êñá">
            üîä<span style="font-size:12px;font-weight:800;margin-left:2px;">zh</span>
          </div>
          <div class="iconbtn" id="moreBtn" title="‰∏ãËºâÊñáÂ≠ó">‚¨á</div>
        </div>
      </div>

      <div class="editor">
        <textarea id="inputText" class="placeholder" spellcheck="false">Ê∫êË™ûË®Ä / ÁøªË≠ØË™ûË®Ä</textarea>
        <div class="status">
          <span class="badge" id="modeBadge">Ê®°ÂºèÔºöÈåÑÈü≥</span>
          <span class="badge" id="netBadge">APIÔºöÊú™Ë®≠ÂÆö</span>
        </div>
      </div>

      <div class="result" id="resultBox" style="display:none;">
        <div class="row">
          <div class="tag">EN</div>
          <div class="textblock" id="outEn"></div>
        </div>
        <div class="row">
          <div class="tag">ZH</div>
          <div class="textblock" id="outZh"></div>
        </div>
      </div>
    </div>

    <!-- History Section -->
    <div class="history-section" id="historySection">
      <div class="history-header">
        <span class="history-title">üìú Ê≠∑Âè≤Á¥ÄÈåÑ</span>
        <button class="history-clear" id="clearHistoryBtn">Ê∏ÖÈô§ÂÖ®ÈÉ®</button>
      </div>
      <div class="history-list" id="historyList">
        <div class="history-empty" id="historyEmpty">Â∞öÁÑ°Ê≠∑Âè≤Á¥ÄÈåÑ</div>
      </div>
    </div>

    <!-- Hidden uploader -->
    <!-- iPhone ÈÅ∏Ê™îÊõ¥È†ÜÔºöaudio/* -->
    <input id="fileInput" type="file" accept="audio/wav" style="display:none" />
  </div>

  <script>
    /***********************
     * 1) Cloud Run API
     ***********************/
    const API_BASE = "https://speech-api-506893213123.europe-west1.run.app";
    const SPEECH_ENDPOINT = () => `${API_BASE}/speech`;

    /***********************
     * 2) DOM
     ***********************/
    const timerEl = document.getElementById("timer");
    const micBtn = document.getElementById("micBtn");
    const micLabel = document.getElementById("micLabel");
    const micMenu = document.getElementById("micMenu");
    const recordBtn = document.getElementById("recordBtn");
    const recordIcon = document.getElementById("recordIcon");
    const modeBadge = document.getElementById("modeBadge");
    const netBadge = document.getElementById("netBadge");
    const fileInput = document.getElementById("fileInput");

    const inputText = document.getElementById("inputText");
    const resultBox = document.getElementById("resultBox");
    const outEn = document.getElementById("outEn");
    const outZh = document.getElementById("outZh");

    const langFromEl = document.getElementById("langFrom");
    const langToEl = document.getElementById("langTo");
    const swapBtn = document.getElementById("swapBtn");

    const speakEnBtn = document.getElementById("speakEnBtn");
    const speakZhBtn = document.getElementById("speakZhBtn");

    // History elements
    const historyList = document.getElementById("historyList");
    const historyEmpty = document.getElementById("historyEmpty");
    const clearHistoryBtn = document.getElementById("clearHistoryBtn");

    // History data
    let historyData = [];

    /***********************
     * 3) UI helpers
     ***********************/
    function setApiBadge(){
      if (!API_BASE) {
        netBadge.textContent = "APIÔºöÊú™Ë®≠ÂÆö";
        netBadge.style.borderColor = "#ffd6d6";
        netBadge.style.color = "#c70000";
      } else {
        netBadge.textContent = "APIÔºöÂ∑≤Ë®≠ÂÆö";
        netBadge.style.borderColor = "#d7f5e3";
        netBadge.style.color = "#0f7a3c";
      }
    }
    setApiBadge();

    // textarea placeholder behavior
    const placeholderText = "Ê∫êË™ûË®Ä / ÁøªË≠ØË™ûË®Ä";
    inputText.addEventListener("focus", () => {
      if (inputText.value.trim() === placeholderText) {
        inputText.value = "";
        inputText.classList.remove("placeholder");
      }
    });
    inputText.addEventListener("blur", () => {
      if (!inputText.value.trim()) {
        inputText.value = placeholderText;
        inputText.classList.add("placeholder");
      }
    });

    // mic menu toggle
    micBtn.addEventListener("click", () => {
      micMenu.style.display = micMenu.style.display === "block" ? "none" : "block";
    });
    document.addEventListener("click", (e) => {
      if (!micMenu.contains(e.target) && !micBtn.contains(e.target)) {
        micMenu.style.display = "none";
      }
    });

    let mode = "mic"; // "mic" | "upload"
    micMenu.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        mode = btn.dataset.mode;
        micMenu.style.display = "none";
        if (mode === "mic") {
          micLabel.textContent = "È∫•ÂÖãÈ¢®";
          modeBadge.textContent = "Ê®°ÂºèÔºöÈåÑÈü≥";
        } else {
          micLabel.textContent = "‰∏äÂÇ≥Èü≥Ê™î";
          modeBadge.textContent = "Ê®°ÂºèÔºö‰∏äÂÇ≥";
        }
      });
    });

    // language pairs (UI‰øùÁïôÔºõÁõÆÂâçÂæåÁ´ØÂè™Âõû text)
    let langFrom = "en";
    let langTo = "zh";
    function renderLang(){
      langFromEl.textContent = langFrom;
      langToEl.textContent = langTo;
    }
    renderLang();

    swapBtn.addEventListener("click", () => {
      [langFrom, langTo] = [langTo, langFrom];
      renderLang();
    });

    /***********************
     * 4) Timer
     ***********************/
    let t0 = null;
    let rafId = null;
    function fmtTime(ms){
      const total = Math.floor(ms / 1000);
      const h = String(Math.floor(total / 3600)).padStart(2,"0");
      const m = String(Math.floor((total % 3600) / 60)).padStart(2,"0");
      const s = String(total % 60).padStart(2,"0");
      return `${h}:${m}:${s}`;
    }
    function startTimer(){
      t0 = performance.now();
      cancelAnimationFrame(rafId);
      const tick = () => {
        const now = performance.now();
        timerEl.textContent = fmtTime(now - t0);
        rafId = requestAnimationFrame(tick);
      };
      rafId = requestAnimationFrame(tick);
    }
    function stopTimer(){
      cancelAnimationFrame(rafId);
      rafId = null;
      t0 = null;
    }
    function resetTimer(){
      timerEl.textContent = "00:00:00";
    }

    /***********************
     * 5) WAV Recorder (iPhone Safari ÂèãÂñÑ)
     ***********************/
    let audioStream = null;
    let audioCtx = null;
    let processor = null;
    let sourceNode = null;
    let gainNode = null;
    let recording = false;
    let pcmData = [];
    let sampleRate = 44100;

    function floatTo16BitPCM(float32Array){
      const buffer = new Int16Array(float32Array.length);
      for (let i=0; i<float32Array.length; i++){
        let s = Math.max(-1, Math.min(1, float32Array[i]));
        buffer[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
      }
      return buffer;
    }

    function writeWavHeader(view, sampleRate, numChannels, numFrames){
      const bytesPerSample = 2;
      const blockAlign = numChannels * bytesPerSample;
      const byteRate = sampleRate * blockAlign;
      const dataSize = numFrames * blockAlign;

      function writeString(offset, str){
        for (let i=0; i<str.length; i++){
          view.setUint8(offset + i, str.charCodeAt(i));
        }
      }

      writeString(0, "RIFF");
      view.setUint32(4, 36 + dataSize, true);
      writeString(8, "WAVE");
      writeString(12, "fmt ");
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true);
      view.setUint16(22, numChannels, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, byteRate, true);
      view.setUint16(32, blockAlign, true);
      view.setUint16(34, 16, true);
      writeString(36, "data");
      view.setUint32(40, dataSize, true);
    }

    function encodeWavFromPCM(pcmChunks, sampleRate, numChannels=1){
      const totalLength = pcmChunks.reduce((acc, arr) => acc + arr.length, 0);
      const buffer = new ArrayBuffer(44 + totalLength * 2);
      const view = new DataView(buffer);
      writeWavHeader(view, sampleRate, numChannels, totalLength);

      let offset = 44;
      for (const chunk of pcmChunks){
        for (let i=0; i<chunk.length; i++){
          view.setInt16(offset, chunk[i], true);
          offset += 2;
        }
      }
      return new Blob([buffer], { type: "audio/wav" });
    }

    async function startRecording(){
      if (recording) return;
      if (!navigator.mediaDevices?.getUserMedia) {
        alert("Ê≠§ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥È∫•ÂÖãÈ¢®ÈåÑÈü≥„ÄÇ");
        return;
      }

      pcmData = [];
      audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });

      audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      // ‚úÖ iPhone Safari Â∏∏ÈúÄË¶Å resume ÊâçÊúÉÁúüÊ≠£ÈñãÂßã
      try { await audioCtx.resume(); } catch(e) {}

      sampleRate = audioCtx.sampleRate;

      sourceNode = audioCtx.createMediaStreamSource(audioStream);
      processor = audioCtx.createScriptProcessor(4096, 1, 1);

      processor.onaudioprocess = (e) => {
        if (!recording) return;
        const input = e.inputBuffer.getChannelData(0);
        pcmData.push(floatTo16BitPCM(input));
      };

      sourceNode.connect(processor);

      // ‚úÖ ‰∏ÄÂÆöË¶ÅÊé•Ôºå‰∏çÁÑ∂ iOS ÂèØËÉΩ‰∏çËß∏Áôº onaudioprocess
      processor.connect(audioCtx.destination);

      // üîá ÈÅøÂÖçÂõûÊéàÔºöÊää gain Ë®≠Êàê 0
      gainNode = audioCtx.createGain();
      gainNode.gain.value = 0;
      processor.disconnect();
      processor.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      recording = true;
      startTimer();

      recordIcon.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none">
          <rect x="7" y="7" width="10" height="10" rx="2" fill="var(--danger)"></rect>
        </svg>
      `;
    }

    async function stopRecording(){
      if (!recording) return null;
      recording = false;

      stopTimer();

      try{
        processor?.disconnect();
        sourceNode?.disconnect();
        gainNode?.disconnect();   // ‚úÖ Êñ∞Â¢û
      }catch(e){}

      if (audioStream){
        audioStream.getTracks().forEach(t => t.stop());
      }

      try{ await audioCtx?.close(); }catch(e){}

      audioCtx = null;
      audioStream = null;
      processor = null;
      sourceNode = null;
      gainNode = null;            // ‚úÖ Êñ∞Â¢û

      recordIcon.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M8 5v14l11-7L8 5z" fill="var(--accent)"></path>
        </svg>
      `;

      resetTimer();

      // ‚úÖ ÈóúÈçµÊ™¢Êü•ÔºöÁúüÁöÑÊúâÊ≤íÊúâÈåÑÂà∞ËÅ≤Èü≥
      console.log("PCM chunks:", pcmData.length);

      if (pcmData.length === 0) {
        alert("‚ö†Ô∏è Ê≤íÊúâÈåÑÂà∞ËÅ≤Èü≥ÔºåË´ãÈáçÊñ∞ÈåÑÈü≥");
        return null;
      }

      const wavBlob = encodeWavFromPCM(pcmData, sampleRate, 1);
      return wavBlob;
    }


    /***********************
     * 6) History functions
     ***********************/
    function formatTimestamp(date) {
      const h = String(date.getHours()).padStart(2, "0");
      const m = String(date.getMinutes()).padStart(2, "0");
      const s = String(date.getSeconds()).padStart(2, "0");
      return `${h}:${m}:${s}`;
    }

    function saveToHistory(textEn, textZh) {
      // Â¶ÇÊûúÊúâÂÖßÂÆπÊâçÂÑ≤Â≠ò
      if (!textEn && !textZh) return;

      const item = {
        id: Date.now(),
        time: new Date(),
        textEn: textEn,
        textZh: textZh
      };

      historyData.unshift(item); // Êñ∞ÁöÑÊîæÊúÄÂâçÈù¢
      renderHistory();
    }

    function renderHistory() {
      // Ê∏ÖÈô§ÁèæÊúâÂÖßÂÆπÔºàÈô§‰∫ÜÁ©∫Ë®äÊÅØÔºâ
      const items = historyList.querySelectorAll(".history-item");
      items.forEach(el => el.remove());

      if (historyData.length === 0) {
        historyEmpty.style.display = "block";
        return;
      }

      historyEmpty.style.display = "none";

      historyData.forEach(item => {
        const div = document.createElement("div");
        div.className = "history-item";
        div.dataset.id = item.id;

        div.innerHTML = `
          <div class="history-time">
            <span>üïê ${formatTimestamp(item.time)}</span>
          </div>
          <div class="history-row">
            <div class="history-tag">EN</div>
            <div class="history-text">${escapeHtml(item.textEn) || "-"}</div>
          </div>
          <div class="history-row">
            <div class="history-tag">ZH</div>
            <div class="history-text">${escapeHtml(item.textZh) || "-"}</div>
          </div>
        `;

        historyList.appendChild(div);
      });
    }

    function escapeHtml(text) {
      if (!text) return "";
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    function clearHistory() {
      historyData = [];
      renderHistory();
    }

    clearHistoryBtn.addEventListener("click", () => {
      if (historyData.length === 0) return;
      if (confirm("Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÊ≠∑Âè≤Á¥ÄÈåÑÂóéÔºü")) {
        clearHistory();
      }
    });

    /***********************
     * 7) Call backend /speech
     * ‚úÖ ÂæåÁ´ØÁõÆÂâçÂõû { text: "..." }
     ***********************/
    async function sendToSpeechApi(wavBlob){
      if (!API_BASE) {
        alert("Ë´ãÂÖàË®≠ÂÆö API_BASE„ÄÇ");
        return;
      }

      // ‚úÖ ÂÖàÂ∞áÁõÆÂâçÁöÑÁµêÊûúÂ≠òÂÖ•Ê≠∑Âè≤Á¥ÄÈåÑÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
      const currentEn = outEn.textContent?.trim() || "";
      const currentZh = outZh.textContent?.trim() || "";
      if (currentEn || currentZh) {
        saveToHistory(currentEn, currentZh);
      }

      modeBadge.textContent = "ËôïÁêÜ‰∏≠‚Ä¶";

      const form = new FormData();
      form.append("file", wavBlob, "record.wav");

      try{
        const res = await fetch(SPEECH_ENDPOINT(), { method: "POST", body: form });

        if (!res.ok) {
          const t = await res.text();
          throw new Error(`HTTP ${res.status}: ${t}`);
        }

        const data = await res.json();

        // ‚úÖ ÂñÆËº∏Âá∫Ôºötext
        const text = (data.text ?? "").trim();
        const translated = (data.translated ?? "").trim();

        outEn.textContent = text;
        outZh.textContent = translated;
        resultBox.style.display = "block";

        if (inputText.value.trim() === placeholderText) {
          inputText.value = "";
          inputText.classList.remove("placeholder");
        }
        inputText.value = text || inputText.value;

        modeBadge.textContent = (mode === "mic") ? "Ê®°ÂºèÔºöÈåÑÈü≥" : "Ê®°ÂºèÔºö‰∏äÂÇ≥";
      } catch (err){
        console.error(err);
        alert("ÂëºÂè´ API Â§±ÊïóÔºö\n" + (err?.message || err));
        modeBadge.textContent = (mode === "mic") ? "Ê®°ÂºèÔºöÈåÑÈü≥" : "Ê®°ÂºèÔºö‰∏äÂÇ≥";
      }
    }

    /***********************
     * 8) Button behavior
     ***********************/
    recordBtn.addEventListener("click", async () => {
      if (mode === "upload") {
        fileInput.click();
        return;
      }

      if (!recording) {
        await startRecording();
      } else {
        const wavBlob = await stopRecording();
        if (wavBlob) await sendToSpeechApi(wavBlob);
      }
    });

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      // iPhone ÈÅ∏Ê™îÂèØËÉΩ type ÊòØ audio/x-wav ÊàñÁîöËá≥Á©∫Â≠ó‰∏≤ÔºåÈÄôË£°‰∏çË¶ÅÂ§™Âö¥Ê†º
      const name = (file.name || "").toLowerCase();

      if (!name.endsWith(".wav")) {
        alert("ÁõÆÂâçÂÉÖÊîØÊè¥ WAV Èü≥Ê™îÔºàLINEAR16Ôºâ„ÄÇ");
        fileInput.value = "";
        return;
      }


      await sendToSpeechApi(file);
      fileInput.value = "";
    });

    /***********************
     * 9) Speak (Web Speech API)
     ***********************/
    function speak(text, lang){
      if (!("speechSynthesis" in window)) {
        alert("Ê≠§ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ÊúóËÆÄÂäüËÉΩ„ÄÇ");
        return;
      }
      window.speechSynthesis.cancel();

      const u = new SpeechSynthesisUtterance(text);
      if (lang === "zh") u.lang = "zh-TW";
      else if (lang === "ja") u.lang = "ja-JP";
      else if (lang === "ko") u.lang = "ko-KR";
      else u.lang = "en-US";

      window.speechSynthesis.speak(u);
    }

    speakEnBtn.addEventListener("click", () => {
      const t = outEn.textContent?.trim() || "";
      if (!t) return alert("Ê≤íÊúâÂÖßÂÆπÂèØÊúóËÆÄ„ÄÇ");
      speak(t, "en");
    });

    speakZhBtn.addEventListener("click", () => {
      const t = outZh.textContent?.trim() || "";
      if (!t) return alert("Ê≤íÊúâ‰∏≠ÊñáÂÖßÂÆπÂèØÊúóËÆÄ„ÄÇ");
      speak(t, "zh");
    });

    /***********************
     * 10) Download button
     ***********************/
    document.getElementById("moreBtn").addEventListener("click", () => {
      const textEn = outEn.textContent?.trim() || "";
      const textZh = outZh.textContent?.trim() || "";

      if (!textEn && !textZh) {
        alert("ÁõÆÂâçÊ≤íÊúâÂÖßÂÆπÂèØ‰∏ãËºâ„ÄÇ");
        return;
      }

      // ÁµÑÂêàÊñáÂ≠óÂÖßÂÆπ
      let content = "";
      content += "=== ÁøªË≠ØÁ¥ÄÈåÑ ===\n";
      content += `ÊôÇÈñìÔºö${new Date().toLocaleString("zh-TW")}\n\n`;
      
      if (textEn) {
        content += `[ÂéüÊñá EN]\n${textEn}\n\n`;
      }
      if (textZh) {
        content += `[ÁøªË≠Ø ZH]\n${textZh}\n`;
      }

      // Âª∫Á´ã‰∏ãËºâ
      const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `ÁøªË≠Ø_${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
